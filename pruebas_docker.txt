## Dockerfile segun ultralytics
# Extends official Ultralytics Docker image for YOLO11
FROM ultralytics/ultralytics:latest-cpu

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    MODEL_PATH=/app/models/best.onnx

# Install FastAPI and dependencies
RUN pip install --no-cache-dir fastapi[all] uvicorn[standard] loguru onnxruntime

WORKDIR /app

# Create directory structure
RUN mkdir -p /app/models /app/logs

# Copy application code
COPY src/ ./src/
COPY pyproject.toml ./

# Copy your ONNX model
COPY models/ /app/models/

# Install the application package
RUN pip install --no-cache-dir -e .

# Set PYTHONPATH to include the src directory
ENV PYTHONPATH=/app/src

# Port for Vertex AI
EXPOSE 8080

# Start the inference server
ENTRYPOINT ["python", "src/main.py"]


##Dockerfile sin ultralyticsFROM python:3.10-slim
FROM python:3.10-slim
# Establece el directorio de trabajo dentro del contenedor
WORKDIR /app
# Instala dependencias del sistema (para pillow, opencv, numpy, etc.)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgl1 \
 && rm -rf /var/lib/apt/lists/*
 # Copiamos solo pyproject.toml primero (mejor cache)
COPY pyproject.toml .
# Instalamos dependencias (CPU only + numpy fix)
RUN pip install --no-cache-dir torch==2.1.0+cpu torchvision==0.16.0+cpu \
    --extra-index-url https://download.pytorch.org/whl/cpu \
 && pip install --no-cache-dir "numpy<2.0.0" \
 && pip install --no-cache-dir .
# Copia codigos y modelos al contenedor
COPY src/ ./src/
COPY models/ ./models/
# Configura el path de Python y el puerto
ENV PYTHONPATH=/app/src
EXPOSE 8080
# Arrancamos con uvicorn (FastAPI server)
CMD ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8080"]


####pyproject.toml para imagen ultralytics
[project]
name = "deploy_vertex"
version = "0.0.1"
description = "Se deplega docker en vertex"
requires-python = ">=3.10,<3.13"
dependencies = [
   "fastapi[all]>=0.89.1",
   "uvicorn[standard]>=0.20.0",
   "loguru>=0.7.0",
   "pillow>=9.0.0",
   "ultralytics>=8.3.0",
]

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"
